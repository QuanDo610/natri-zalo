// Prisma Schema for Natri Loyalty Points System (v2 — multi-role + OTP + refresh tokens)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  STAFF
  DEALER
  CUSTOMER
}

// ── Staff / Admin users (username+password login) ──────────────────
model User {
  id        String   @id @default(uuid())
  username  String   @unique @db.VarChar(50)
  password  String   @db.VarChar(255)
  fullName  String   @db.VarChar(100)
  role      Role     @default(STAFF)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activations    Activation[]
  auditLogs      AuditLog[]
  barcodesCreated BarcodeItem[] @relation("BarcodesCreated")
  barcodesUsed    BarcodeItem[] @relation("BarcodesUsed")

  @@map("users")
}

// ── Unified account for Customer / Dealer (OTP login) ──────────────
model UserAccount {
  id         String   @id @default(uuid())
  phone      String   @unique @db.VarChar(15)
  role       Role     // CUSTOMER or DEALER
  customerId String?  @unique
  dealerId   String?  @unique
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer      Customer?      @relation(fields: [customerId], references: [id])
  dealer        Dealer?        @relation(fields: [dealerId], references: [id])
  refreshTokens RefreshToken[]

  @@index([phone])
  @@map("user_accounts")
}

// ── Refresh tokens ─────────────────────────────────────────────────
model RefreshToken {
  id            String   @id @default(uuid())
  token         String   @unique @db.VarChar(500)
  userAccountId String?
  userId        String?  // for staff/admin users
  expiresAt     DateTime
  revoked       Boolean  @default(false)
  createdAt     DateTime @default(now())

  userAccount UserAccount? @relation(fields: [userAccountId], references: [id])

  @@index([token])
  @@index([userAccountId])
  @@map("refresh_tokens")
}

// ── OTP codes ──────────────────────────────────────────────────────
model OtpCode {
  id        String   @id @default(uuid())
  phone     String   @db.VarChar(15)
  code      String   @db.VarChar(6)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone, code])
  @@map("otp_codes")
}

model Dealer {
  id        String   @id @default(uuid())
  code      String   @unique @db.VarChar(20)
  name      String   @db.VarChar(100)
  phone     String   @db.VarChar(15)
  shopName  String   @db.VarChar(200)
  address   String?  @db.Text
  points    Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activations Activation[]
  userAccount UserAccount?

  @@index([code])
  @@map("dealers")
}

model Product {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(200)
  sku       String   @unique @db.VarChar(50)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  barcodeItems BarcodeItem[]
  activations  Activation[]

  @@map("products")
}

enum BarcodeStatus {
  UNUSED
  USED
}

model BarcodeItem {
  id          String        @id @default(uuid())
  barcode     String        @unique @db.VarChar(100)
  productId   String
  status      BarcodeStatus @default(UNUSED)
  activated   Boolean       @default(false)
  activatedAt DateTime?
  createdById String?       // staff/admin who added this barcode
  usedById    String?       // staff who used it in activation
  createdAt   DateTime      @default(now())

  product    Product     @relation(fields: [productId], references: [id])
  createdBy  User?       @relation("BarcodesCreated", fields: [createdById], references: [id])
  usedBy     User?       @relation("BarcodesUsed", fields: [usedById], references: [id])
  activation Activation?

  @@index([barcode])
  @@index([productId])
  @@index([status])
  @@index([createdById])
  @@map("barcode_items")
}

model Customer {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(100)
  phone     String   @unique @db.VarChar(15)
  points    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activations Activation[]
  userAccount UserAccount?

  @@index([phone])
  @@map("customers")
}

model Activation {
  id            String   @id @default(uuid())
  barcodeItemId String   @unique
  customerId    String
  dealerId      String?
  staffId       String?
  productId     String
  pointsAwarded Int      @default(1)
  createdAt     DateTime @default(now())

  barcodeItem BarcodeItem @relation(fields: [barcodeItemId], references: [id])
  customer    Customer    @relation(fields: [customerId], references: [id])
  dealer      Dealer?     @relation(fields: [dealerId], references: [id])
  staff       User?       @relation(fields: [staffId], references: [id])
  product     Product     @relation(fields: [productId], references: [id])

  @@index([customerId, createdAt])
  @@index([dealerId, createdAt])
  @@index([staffId])
  @@index([createdAt])
  @@map("activations")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String   @db.VarChar(50)
  entity    String   @db.VarChar(50)
  entityId  String?
  userId    String?
  metadata  Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}
